From 49660131ad4515126d1ec6247891ac2200e9d7fa Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Sun, 10 Dec 2023 10:57:37 +0800
Subject: [PATCH 3/3] mediatek:update rax3000m ubootmod support

---
 .../mt7981b-cmcc-rax3000m-nand-ubootmod.dts   | 154 ++----------------
 .../mediatek/dts/mt7981b-cmcc-rax3000m.dts    |   2 +-
 2 files changed, 11 insertions(+), 145 deletions(-)

diff --git a/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-nand-ubootmod.dts b/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-nand-ubootmod.dts
index 681401bd74..d226b360e3 100644
--- a/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-nand-ubootmod.dts
+++ b/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m-nand-ubootmod.dts
@@ -1,107 +1,25 @@
 // SPDX-License-Identifier: GPL-2.0-or-later OR MIT
 
 /dts-v1/;
-#include <dt-bindings/gpio/gpio.h>
-#include <dt-bindings/input/input.h>
-
-#include "mt7981.dtsi"
+#include "mt7981b-cmcc-rax3000m.dts"
 
 / {
 	model = "CMCC RAX3000M NAND version (custom U-Boot layout)";
 	compatible = "cmcc,rax3000m-nand-ubootmod", "mediatek,mt7981";
 
 	aliases {
-		led-boot = &red_led;
-		led-failsafe = &red_led;
-		led-running = &green_led;
-		led-upgrade = &green_led;
-		serial0 = &uart0;
-	};
-
-	chosen {
-		stdout-path = "serial0:115200n8";
-	};
-
-	memory {
-		reg = <0 0x40000000 0 0x10000000>;
-	};
-
-	gpio-keys {
-		compatible = "gpio-keys";
-
-		button-reset {
-			label = "reset";
-			linux,code = <KEY_RESTART>;
-			gpios = <&pio 1 GPIO_ACTIVE_LOW>;
-		};
-
-		button-mesh {
-			label = "mesh";
-			linux,code = <BTN_9>;
-			linux,input-type = <EV_SW>;
-			gpios = <&pio 0 GPIO_ACTIVE_LOW>;
-		};
-	};
-
-	gpio-leds {
-		compatible = "gpio-leds";
-
-		green_led: led-0 {
-			label = "green:status";
-			gpios = <&pio 9 GPIO_ACTIVE_LOW>;
-		};
-
-		led-1 {
-			label = "blue:status";
-			gpios = <&pio 12 GPIO_ACTIVE_LOW>;
-		};
-
-		red_led: led-2 {
-			label = "red:status";
-			gpios = <&pio 35 GPIO_ACTIVE_LOW>;
-		};
+		label-mac-device = &gmac1;
 	};
 };
 
-&eth {
-	status = "okay";
-
-	gmac0: mac@0 {
-		compatible = "mediatek,eth-mac";
-		reg = <0>;
-		phy-mode = "2500base-x";
-
-		nvmem-cells = <&macaddr_factory_2a>;
-		nvmem-cell-names = "mac-address";
-
-		fixed-link {
-			speed = <2500>;
-			full-duplex;
-			pause;
-		};
-	};
-
-	gmac1: mac@1 {
-		compatible = "mediatek,eth-mac";
-		reg = <1>;
-		phy-mode = "gmii";
-		phy-handle = <&int_gbe_phy>;
-
-		nvmem-cells = <&macaddr_factory_24>;
-		nvmem-cell-names = "mac-address";
-	};
+&gmac0 {
+	nvmem-cells = <&macaddr_factory_2a>;
+	nvmem-cell-names = "mac-address";
 };
 
-&mdio_bus {
-	switch: switch@0 {
-		compatible = "mediatek,mt7531";
-		reg = <31>;
-		reset-gpios = <&pio 39 GPIO_ACTIVE_HIGH>;
-		interrupt-controller;
-		#interrupt-cells = <1>;
-		interrupt-parent = <&pio>;
-		interrupts = <38 IRQ_TYPE_LEVEL_HIGH>;
-	};
+&gmac1 {
+	nvmem-cells = <&macaddr_factory_24>;
+	nvmem-cell-names = "mac-address";
 };
 
 &spi0 {
@@ -116,8 +34,8 @@
 		reg = <0>;
 
 		spi-max-frequency = <52000000>;
-		spi-tx-buswidth = <4>;
-		spi-rx-buswidth = <4>;
+		spi-tx-bus-width = <4>;
+		spi-rx-bus-width = <4>;
 		mediatek,nmbm;
 		mediatek,bmt-max-ratio = <1>;
 		mediatek,bmt-max-reserved-blocks = <64>;
@@ -168,40 +86,6 @@
 	};
 };
 
-&switch {
-	ports {
-		#address-cells = <1>;
-		#size-cells = <0>;
-
-		port@0 {
-			reg = <0>;
-			label = "lan3";
-		};
-
-		port@1 {
-			reg = <1>;
-			label = "lan2";
-		};
-
-		port@2 {
-			reg = <2>;
-			label = "lan1";
-		};
-
-		port@6 {
-			reg = <6>;
-			ethernet = <&gmac0>;
-			phy-mode = "2500base-x";
-
-			fixed-link {
-				speed = <2500>;
-				full-duplex;
-				pause;
-			};
-		};
-	};
-};
-
 &pio {
 	spi0_flash_pins: spi0-pins {
 		mux {
@@ -223,24 +107,6 @@
 	};
 };
 
-&uart0 {
-	status = "okay";
-};
-
-&usb_phy {
-	status = "okay";
-};
-
-&watchdog {
-	status = "okay";
-};
-
 &wifi {
-	status = "okay";
-
 	mediatek,mtd-eeprom = <&factory 0x0>;
 };
-
-&xhci {
-	status = "okay";
-};
diff --git a/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m.dts b/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m.dts
index e9c850e85b..3f330f40fa 100644
--- a/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m.dts
+++ b/target/linux/mediatek/dts/mt7981b-cmcc-rax3000m.dts
@@ -90,7 +90,7 @@
 };
 
 &mdio_bus {
-	switch: switch@0 {
+	switch: switch@1f {
 		compatible = "mediatek,mt7531";
 		reg = <31>;
 		reset-gpios = <&pio 39 GPIO_ACTIVE_HIGH>;
-- 
2.34.1

